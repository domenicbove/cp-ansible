- name: Set inter.broker.protocol.version
  lineinfile:
    path: "{{kafka.broker.config_file}}"
    regexp: 'inter.broker.protocol.version=.*'
    line: 'inter.broker.protocol.version=2.1'

- name: Set log.message.format.version
  lineinfile:
    path: "{{kafka.broker.config_file}}"
    regexp: 'log.message.format.version=.*'
    line: 'log.message.format.version=2.1'

- name: Create backup directory
  file:
    path: "{{kafka.broker.backup_dir}}"
    state: directory
    mode: 0755

- name: Backup /etc/kafka
  copy:
    src: "{{ item }}"
    dest: "{{kafka.broker.backup_dir}}/{{ item | basename }}"
    remote_src: yes
  with_items:
    - "{{ kafka.broker.config_file }}"
    # - "{{ kafka.broker.systemd_file }}"

- name: Stop kafka
  systemd:
    name: "{{kafka.broker.service_name}}"
    state: stopped

- name: Remove old confluent-kafka package
  yum:
    name: "{{kafka.old_package_name}}"
    state: absent

- name: Remove Confluent Dist Yum Repo
  yum_repository:
    name: Confluent.dist
    file: confluent
    state: absent
  notify: yum-clean-all

- name: Remove Old Confluent Yum Repo
  yum_repository:
    name: Confluent
    file: confluent
    state: absent
  notify: yum-clean-all

- name: Add New Confluent Yum Repo
  yum_repository:
    name: confluent-5.2
    file: confluent
    description: "Confluent repository for 5.2.x packages"
    baseurl: "{{confluent.repository.redhat.main.baseurl}}"
    gpgcheck: "{{confluent.repository.redhat.main.gpgcheck}}"
    gpgkey: "{{confluent.repository.redhat.main.gpgkey}}"
    enabled: "{{confluent.repository.redhat.main.enabled}}"
  notify: yum-clean-all

- meta: flush_handlers

- name: Install new confluent-kafka package
  yum:
    name: "{{kafka.new_package_name}}"
    state: latest
  notify:
    - reload systemd
    - restart kafka

- name: Restore /etc/kafka
  copy:
    src: "{{kafka.broker.backup_dir}}/{{ item | basename }}"
    dest: "{{ item }}"
    remote_src: yes
  with_items:
    - "{{kafka.broker.config_file}}"
    # - "{{ kafka.broker.systemd_file }}"

- meta: flush_handlers

# - name: restart kafka
#   systemd:
#     name: "{{kafka.broker.service_name}}"
#     state: restarted
